from fastapi import FastAPI, Request, Form, HTTPException, File, UploadFile
from fastapi.responses import FileResponse
import os
import shutil
# Make sure PARSERS and METTA_FILES_DIR are defined correctly in your app
# from parsers.csv_parser import parse_csv
# from parsers.json_parser import parse_json
# from parsers.txt_parser import parse_txt

# METTA_FILES_DIR = "metta_files"
# os.makedirs(METTA_FILES_DIR, exist_ok=True)
# PARSERS = {
#     "csv": parse_csv,
#     "json": parse_json,
#     "txt": parse_txt,
# }


@app.post("/convert")
async def convert(
    request: Request,
    source_type: str = Form(...),
    file: UploadFile = File(...),
):
    """
    Handles file conversion and serves the converted file for download.
    """
    if not file.filename:
        raise HTTPException(status_code=400, detail="No file provided")

    parser_fn = PARSERS.get(source_type)
    if not parser_fn:
        raise HTTPException(status_code=400, detail="Invalid source type")

    temp_file_path = f"temp_{file.filename}"
    try:
        # Save uploaded file temporarily to process it
        with open(temp_file_path, "wb") as buffer:
            shutil.copyfileobj(file.file, buffer)

        # Parse the file to get MeTTa content
        metta_lines = parser_fn(temp_file_path)

        # Define the path and name for the output .metta file
        base_filename, _ = os.path.splitext(file.filename)
        metta_filename = f"{base_filename}.metta"
        metta_file_path = os.path.join(METTA_FILES_DIR, metta_filename)

        # Save the converted content to the .metta file
        with open(metta_file_path, "w", encoding="utf-8") as f:
            f.write("\n".join(line.rstrip() for line in metta_lines))

        # Return the generated file as a downloadable response
        return FileResponse(
            path=metta_file_path,
            filename=metta_filename,
            media_type='application/octet-stream'
        )

    except Exception as e:
        # Handle potential errors during conversion
        raise HTTPException(status_code=500, detail=f"Error during conversion: {e}")

    finally:
        # Ensure the temporary file is removed even if errors occur
        if os.path.exists(temp_file_path):
            os.remove(temp_file_path)