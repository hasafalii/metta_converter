from fastapi.responses import FileResponse

@app.post("/convert")
async def convert(
    request: Request,
    source_type: str = Form(...),
    file: UploadFile = File(None),
):
    parser_fn = PARSERS.get(source_type)
    if not parser_fn:
        raise HTTPException(status_code=400, detail="Invalid source type")

    if not file or not file.filename:
        raise HTTPException(status_code=400, detail="No file provided")

    # Save the uploaded file temporarily
    temp_file_path = f"temp_{file.filename}"
    with open(temp_file_path, "wb") as buffer:
        shutil.copyfileobj(file.file, buffer)

    # Parse the file
    metta_lines = parser_fn(temp_file_path)

    # Clean up the temporary file
    os.remove(temp_file_path)

    # Save the converted MeTTa file
    metta_file_path = os.path.join(METTA_FILES_DIR, f"{file.filename}.metta")
    save_metta_file(file.filename, metta_lines)

    # Return it as a download
    return FileResponse(
        path=metta_file_path,
        media_type='application/octet-stream',
        filename=f"{file.filename}.metta"
    )
